var socketioClient    = require('socket.io-client');
var clientCookie 	  = require('client-cookie-utils');
var feedManager 	  = require('feed-manager');
var config 			  = require('config');

var MainServer = module.exports = {
	isConnected : false,
	clientID : "",
	socket:null,
	start : function(clientID){
		console.log("MainServer // Connecting to ..."+config.get("Socket.baseUrl"));
		MainServer.clientID = clientID;
		var socket = socketioClient(config.get("Socket.baseUrl")+'rpi');
		socket.on('connect', function(){
			MainServer.isConnected = true;
  			console.log("MainServer // Connected");
  			socket.emit("clientIdentification",{clientID:MainServer.clientID});
		});

		socket.on('event', function(data){
			console.log('some event ...');
		});

		socket.on('requestFeed',function(data, fn){
			console.log("/// REQUEST FEED /// "+data.feedName);
			feedManager.publishFeed(data.feedName,function(result){
				console.log(result);
			});
		});

		socket.on('disconnect', function(){
			MainServer.isConnected = false;
		  console.log("MainServer // Disconnected !");
		});

		socket.on('rpiConnectionsUpdates',function(data){
		  console.log("Mapping updated ");
		});

		MainServer.socket = socket;
	},
	sendFeedStatusUpdate: function(status){
  		MainServer.socket.emit("feedStatusUpdate",status);
	},
	attemptStart : function(){
		if (MainServer.isConnected) return;

		if (clientCookie.isClientCookiePresent()){
			console.log("WiTouch MainServer :: Client JSON present");
			MainServer.start(clientCookie.getID());
		} else {
			console.log("WiTouch MainServer :: Client JSON not present");	
		}
	}
}